<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Create APIs using Golang | Part 3 : Connecting to a Database. ::
        ssentinull — a simple about / blog / portfolio site
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Introduction. In a fully functioning app, a user can do actions on data. A user is also able to input his or her data into the system. To store and retrieve data, we need the help of a database.
What is a Database. A database is a place where we store persistent data, meaning that the data will still exist even after the database application is stopped. The opposite of persistent data is non-persistent data, eg: in-memory cache, a topic that we&amp;rsquo;ll cover in the next article."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/blogs/create-api-using-golang-database/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Create APIs using Golang | Part 3 : Connecting to a Database."/>
<meta name="twitter:description" content="Where are we gonna store all this data?"/>



<meta property="og:title" content="Create APIs using Golang | Part 3 : Connecting to a Database." />
<meta property="og:description" content="Where are we gonna store all this data?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blogs/create-api-using-golang-database/" /><meta property="article:section" content="blogs" />
<meta property="article:published_time" content="2023-05-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-05-19T00:00:00+00:00" />



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >ssentinull</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/blogs">Blogs</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/blogs">Blogs</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Create APIs using Golang | Part 3 : Connecting to a Database.</h1>
    <div class="post-meta">
      
        <span class="post-date">
          19-05-2023
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by ssentinull</span
        >


      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/database/">#database</a>&nbsp;
        
          <a href="/tags/api/">#api</a>&nbsp;
        
          <a href="/tags/golang/">#golang</a>&nbsp;
        
      </span>
    

    
      <figure class="post-cover">
        
          <img src="/img/blogs/create-api-using-golang-db/0.jpg" alt="Create APIs using Golang | Part 3 : Connecting to a Database." />
        

        
      </figure>
    

    <div class="post-content">
      
      <h2 id="introduction">Introduction.</h2>
<p>In a fully functioning app, a user can do actions on data. A user is also able to input his or her data into the system. To store and retrieve data, we need the help of a database.</p>
<h2 id="what-is-a-database">What is a Database.</h2>
<p>A database is a place where we store persistent data, meaning that the data will still exist even after the database application is stopped. The opposite of persistent data is non-persistent data, eg: in-memory cache, a topic that we&rsquo;ll cover in the next article.</p>
<p>There are different paradigms of database and we select a paradigm based on our usecase. <a href="https://www.youtube.com/@Fireship">Fireship</a> made an excellent video explaining the different kinds of database paradigms that you can check out below.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/W2Z7fbCLSTw" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Since the library app we want to create is structured and transactional, we&rsquo;ll use a Relational Database. According to <a href="https://cloud.google.com/learn/what-is-a-relational-database">Google</a>, a relational database is a way of structuring information in tables, rows, and columns. A relational database can establish links (also known as relationships) between information by joining tables, which makes it easy to understand and gain insights into the relationships between various data points. To manage data inside of a relational database, SQL (Structured Query Language) is used.</p>
<p>Among the various options of relational databases available for free to use, we picked <a href="https://www.postgresql.org/">Postgres</a>, a powerful and open-source object-relational database system that uses and extends the SQL language combined with many features that safely store and scale the most complicated data workloads.</p>
<h2 id="creating-a-schema">Creating a Schema.</h2>
<p>We can visualize a relational database as a series of tables that are connected via specific columns. The tables are domains of data, the columns are attributes of the domain, and the rows are instances of the domain.</p>
<p>Usually, the tables we need would correspond to the models that are defined in our application. But this rule might not always be the case. It goes back to the requirements of the application and whether or not we need to save the data generated in that specific domain.</p>
<p>Looking at the model defined in this application, <em>Book</em>, we can say that we need a <em>books</em> table, and the columns of the table will follow the attributes of the model. Different people have different conventions for naming tables. Personally, I use all small letters, snake case, and plural naming conventions, eg; <em>borrowed_books</em>.</p>

  <figure class="center" >
    <img src="/img/blogs/create-api-using-golang-db/1.png"   />
    
      <figcaption class="center" >books table</figcaption>
    
  </figure>


<h2 id="setting-up-a-migration">Setting up a Migration.</h2>
<p>After we know what the table will look like, now we need to create the table. We do this by creating a Migration. Migration is a concept of modifying a database using multiple separate SQL commands that are created only when we need to make changes to the database. These SQL commands are then run sequentially from the earliest to the latest (if you&rsquo;re doing a fresh migration) or only the latest (if you&rsquo;re running an existing migration). We need to implement a migration because database is a critical component of a backend system and we can&rsquo;t modify it without proper tracking and documentation.</p>
<p>For creating the migration, we use a tool called <a href="https://github.com/golang-migrate/migrate">migrate</a>. This tool supports a wide array of databases and allows us to create and run our migrations directly from the command line. To create a migration, run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ migrate create -ext sql -dir &lt;migrations_destination_path&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># example</span>
</span></span><span style="display:flex;"><span>$ migrate create -ext sql -dir db/migration create_cakes_table
</span></span></code></pre></div><p>Notice that the migration tool has created two files in the <code>/db/migration</code> directory, a <code>&lt;timestamp&gt;_create_books_table.up.sql</code> and a <code>&lt;timestamp&gt;_create_books_table.down.sql</code>. The <code>.up.sql</code> file is used to add new changes to our database and the <code>.down.sql</code> is used to revert the changes we made. So essentially, one file should do the exact opposite of what the other is doing. This is done so that there will be no unreverted changes if we ever need to roll back our migrations.</p>



  <div class="collapsable-code">
    <input id="1" type="checkbox"  />
    <label for="1">
      <span class="collapsable-code__language">sql</span>
      <span class="collapsable-code__title">/db/migration/create_books_table.up.go</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-sql" ><code>

    -- &#43;migrate Up
    CREATE TABLE IF NOT EXISTS &#34;books&#34; (
        &#34;id&#34; BIGINT PRIMARY KEY,
        &#34;title&#34; TEXT NOT NULL,
        &#34;author&#34; TEXT NOT NULL DEFAULT &#39;&#39;,
        &#34;description&#34; TEXT NOT NULL DEFAULT &#39;&#39;,
        &#34;published_date&#34; DATE,
        &#34;created_at&#34; TIMESTAMP NOT NULL DEFAULT &#39;now()&#39;,
        &#34;updated_at&#34; TIMESTAMP NOT NULL DEFAULT &#39;now()&#39;,
        &#34;deleted_at&#34; TIMESTAMP
    );

</code></pre>
  </div>





  <div class="collapsable-code">
    <input id="2" type="checkbox"  />
    <label for="2">
      <span class="collapsable-code__language">sql</span>
      <span class="collapsable-code__title">/db/migration/create_books_table.down.go</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-sql" ><code>

    -- &#43;migrate Down
    DROP TABLE IF EXISTS &#34;books&#34;;

</code></pre>
  </div>


<p>Now that we&rsquo;ve created the SQL query to create our books table, we need to create the Golang script for automatic migration. Like I said before, migrate can be run using the command line, but since we&rsquo;re already using a <code>Makefile</code> to create custom commands, might as well create a Golang script and add it to our <code>Makefile</code> to simplify the process.</p>
<blockquote>
<p>❗ <strong>Disclaimer</strong> ❗</p>
<p>The entire database implementation is not included in this article because it would be too long. So if you&rsquo;re following along with this article and run into missing codes, you can check out the <a href="https://github.com/ssentinull/create-apis-using-golang">Github repo</a>.</p>
</blockquote>



  <div class="collapsable-code">
    <input id="3" type="checkbox"  />
    <label for="3">
      <span class="collapsable-code__language">go</span>
      <span class="collapsable-code__title">/cmd/migration/main.go</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-go" ><code>

    package main

    import (
        &#34;flag&#34;
        &#34;os&#34;

        migrate &#34;github.com/golang-migrate/migrate/v4&#34;
        &#34;github.com/golang-migrate/migrate/v4/database/postgres&#34;
        _ &#34;github.com/golang-migrate/migrate/v4/source/file&#34;
        &#34;github.com/sirupsen/logrus&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/config&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/db&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/utils&#34;
    )

    // initialize logger configurations
    func initLogger() {
        logLevel := logrus.ErrorLevel
        switch config.Env() {
        case &#34;dev&#34;, &#34;development&#34;:
            logLevel = logrus.InfoLevel
        }

        logrus.SetFormatter(&amp;logrus.TextFormatter{
            ForceColors:     true,
            DisableSorting:  true,
            DisableColors:   false,
            FullTimestamp:   true,
            TimestampFormat: &#34;15:04:05 02-01-2006&#34;,
        })

        logrus.SetOutput(os.Stdout)
        logrus.SetReportCaller(true)
        logrus.SetLevel(logLevel)
    }

    func init() {
        config.GetConf()
        initLogger()
    }

    func main() {
        direction := flag.String(&#34;direction&#34;, &#34;up&#34;, &#34;migration direction&#34;)
        step := flag.Int(&#34;step&#34;, 0, &#34;migration step&#34;)

        flag.Parse()
        db.InitializePostgresConn()

        sqlDB, err := db.PostgresDB.DB()
        if err != nil {
            logrus.WithField(&#34;DatabaseDSN&#34;, config.DatabaseDSN()).Fatal(&#34;Failed to connect database: &#34;, err)
        }

        driver, err := postgres.WithInstance(sqlDB, &amp;postgres.Config{})
        if err != nil {
            logrus.WithField(&#34;sqlDB&#34;, utils.Dump(sqlDB)).Fatal(&#34;Failed to create driver: &#34;, err)
        }

        migrations, err := migrate.NewWithDatabaseInstance(&#34;file://db/migration&#34;, &#34;postgres&#34;, driver)
        if err != nil {
            logrus.WithField(&#34;driver&#34;, utils.Dump(driver)).Fatal(&#34;Failed to create migration instance: &#34;, err)
        }

        migrations.Steps(*step)
        switch *direction {
        case &#34;up&#34;:
            err = migrations.Up()
        case &#34;down&#34;:
            err = migrations.Down()
        default:
            logrus.WithField(&#34;direction&#34;, *direction).Error(&#34;invalid direction: &#34;, *direction)
            return
        }

        if err != nil {
            logrus.WithFields(logrus.Fields{
                &#34;migrations&#34;: utils.Dump(migrations),
                &#34;direction&#34;:  direction,
            }).Fatal(&#34;Failed to migrate database: &#34;, err)
        }

        logrus.Infof(&#34;Applied migrations from step %d!\n&#34;, *step)
    }

</code></pre>
  </div>





  <div class="collapsable-code">
    <input id="4" type="checkbox"  />
    <label for="4">
      <span class="collapsable-code__language">Makefile</span>
      <span class="collapsable-code__title">Makefile</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-Makefile" ><code>

    # command to run migration up
    migrate-up:
        go run internal/cmd/migration/main.go -direction=up -step=0

    # command to run migration down
    migrate-down:
        go run internal/cmd/migration/main.go -direction=down -step=0

</code></pre>
  </div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ make migrate-up
</span></span></code></pre></div><p>If we try running the migration command above and we check our database client (in this case I use <a href="https://dbeaver.io/">DBeaver</a>), we can see that our books table has been created.</p>

  <figure class="center" >
    <img src="/img/blogs/create-api-using-golang-db/3.png"   />
    
      <figcaption class="center" >books table has been created</figcaption>
    
  </figure>


<h2 id="using-an-orm">Using an ORM.</h2>
<p>ORM stands for Object Relational Mapping. It&rsquo;s a technique used in creating a <em>bridge</em> between object-oriented programs and relational databases. An ORM composes SQL statements using programming paradigms and data structures native to that programming language and then executes those statements to the database it&rsquo;s connected to. Some benefits of ORM are;</p>
<ol>
<li>It&rsquo;s easier to create simple to moderately complex queries.</li>
<li>It hides the complex processes under the hood and only lets you worry about the high-level implementation.</li>
<li>It improves the security of the application because most ORM eliminates the possibility of a SQL injection attack.</li>
</ol>
<p>But there are also drawbacks of using an ORM, such as;</p>
<ol>
<li>You might not fully understand the queries that are being composed by an ORM.</li>
<li>An ORM might not be able to compose the most complex of queries.</li>
<li>As the queries become more complex, you might run into performance issues.</li>
</ol>
<p>Since our library app will not have complex queries, I think we should use an ORM. Our ORM of choice is <a href="https://gorm.io/">Gorm</a>. After installing Gorm, we can implement it in our repository layer.</p>



  <div class="collapsable-code">
    <input id="5" type="checkbox"  />
    <label for="5">
      <span class="collapsable-code__language">go</span>
      <span class="collapsable-code__title">/repository/book_repository.go</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-go" ><code>

    package postgres

    import (
        &#34;context&#34;

        &#34;github.com/sirupsen/logrus&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/model&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/utils&#34;
        &#34;gorm.io/gorm&#34;
    )

    type bookRepo struct {
        db *gorm.DB
    }

    func NewBookRepository(db *gorm.DB) model.BookRepository {
        return &amp;bookRepo{db: db}
    }

    func (br *bookRepo) Create(ctx context.Context, book *model.Book) error {
        err := br.db.WithContext(ctx).Transaction(func(tx *gorm.DB) error {
            if err := tx.Create(book).Error; err != nil {
                return err

            }
            return nil
        })

        if err != nil {
            logrus.WithFields(logrus.Fields{
                &#34;ctx&#34;:  utils.Dump(ctx),
                &#34;book&#34;: utils.Dump(book),
            }).Error(err)
            return err
        }

        return nil
    }

    func (br *bookRepo) DeleteByID(ctx context.Context, ID int64) error {
        err := br.db.WithContext(ctx).Transaction(func(tx *gorm.DB) error {
            if err := tx.Delete(&amp;model.Book{}, ID).Error; err != nil {
                return err
            }
            return nil
        })

        if err != nil {
            logrus.WithFields(logrus.Fields{
                &#34;ctx&#34;: utils.Dump(ctx),
                &#34;ID&#34;:  ID,
            }).Error(err)
            return err
        }

        return nil
    }

    func (br *bookRepo) FindByID(ctx context.Context, ID int64) (*model.Book, error) {
        book := &amp;model.Book{}
        err := br.db.WithContext(ctx).Where(&#34;id = ?&#34;, ID).Take(&amp;book).Error
        if err != nil {
            logrus.WithFields(logrus.Fields{
                &#34;ctx&#34;: utils.Dump(ctx),
                &#34;ID&#34;:  ID,
            }).Error(err)
            return nil, err
        }

        return book, nil
    }

    func (br *bookRepo) FindAll(ctx context.Context) ([]*model.Book, error) {
        books := []*model.Book{}
        err := br.db.WithContext(ctx).Order(&#34;id DESC&#34;).Find(&amp;books).Error
        if err != nil {
            logrus.WithField(&#34;ctx&#34;, utils.Dump(ctx)).Error(err)
            return nil, err
        }

        return books, nil
    }

    func (br *bookRepo) Update(ctx context.Context, book *model.Book) (*model.Book, error) {
        err := br.db.WithContext(ctx).Transaction(func(tx *gorm.DB) error {
            if err := tx.Updates(book).Error; err != nil {
                return err
            }

            return nil
        })

        if err != nil {
            logrus.WithFields(logrus.Fields{
                &#34;ctx&#34;:  utils.Dump(ctx),
                &#34;book&#34;: utils.Dump(book),
            }).Error(err)
            return nil, err
        }

        return br.FindByID(ctx, book.ID)
    }

</code></pre>
  </div>


<p>Let&rsquo;s take a closer look at the modifications we&rsquo;ve made, shall we.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">bookRepo</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewBookRepository</span>(<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>) <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">BookRepository</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bookRepo</span>{<span style="color:#a6e22e">db</span>: <span style="color:#a6e22e">db</span>}
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>We created a <code>db</code> field of type <code>*gorm.DB</code> in the <code>bookRepo</code> struct. This is the Gorm object that is connected to our database that we&rsquo;ll use to interact with our database. We also added a <code>db *gorm.DB</code> parameter to our <code>NewBookRepository()</code> constructor so that we can inject our <code>*gorm.DB</code> dependency.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">br</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bookRepo</span>) <span style="color:#a6e22e">FindByID</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">int64</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Book</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">book</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Book</span>{}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">br</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">WithContext</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">ID</span>).<span style="color:#a6e22e">Take</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">book</span>).<span style="color:#a6e22e">Error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">WithFields</span>(<span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Fields</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ctx&#34;</span>: <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">Dump</span>(<span style="color:#a6e22e">ctx</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ID&#34;</span>:  <span style="color:#a6e22e">ID</span>,
</span></span><span style="display:flex;"><span>            }).<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">book</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>To interact with our database, we simply call the functions that we want to use on the <code>db</code> field that we previously added. In the example above, we want to find a book by its <code>id</code>, so we simply chain three different functions and a value:</p>
<ol>
<li><code>WithContext()</code>; change the current instance <code>db</code>&rsquo;s context to <code>ctx</code>.</li>
<li><code>Where()</code>; append a <code>WHERE &lt;param&gt; = ?</code> clause to the SQL query based on the input parameters, in this case, the clause would be <code>WHERE id = id</code>.</li>
<li><code>Take()</code>; executes the query, returns the first row that satisfies the <code>WHERE</code> clause above, and assigns the returned value to the <code>book</code> variable.</li>
<li><code>Error</code>; returns the error value of the chained function.</li>
</ol>
<h2 id="updating-our-server-implementation">Updating Our Server Implementation.</h2>
<p>Now that we&rsquo;ve added our database to our repository, it&rsquo;s time to instantiate and inject it into our server.</p>



  <div class="collapsable-code">
    <input id="6" type="checkbox"  />
    <label for="6">
      <span class="collapsable-code__language">go</span>
      <span class="collapsable-code__title">/repository/book_repository.go</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-go" ><code>

    package main

    import (
        &#34;net/http&#34;
        &#34;os&#34;
        &#34;time&#34;

        &#34;github.com/labstack/echo/v4&#34;
        &#34;github.com/sirupsen/logrus&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/config&#34;
        &#34;github.com/ssentinull/create-apis-using-golang/internal/db&#34;
        _bookHTTPHndlr &#34;github.com/ssentinull/create-apis-using-golang/internal/delivery/http&#34;
        _bookRepo &#34;github.com/ssentinull/create-apis-using-golang/internal/repository&#34;
        _bookUcase &#34;github.com/ssentinull/create-apis-using-golang/internal/usecase&#34;
    )

    // initialize logger configurations
    func initLogger() {
        logLevel := logrus.ErrorLevel
        switch config.Env() {
        case &#34;dev&#34;, &#34;development&#34;:
            logLevel = logrus.InfoLevel
        }

        logrus.SetFormatter(&amp;logrus.TextFormatter{
            ForceColors:     true,
            DisableSorting:  true,
            DisableColors:   false,
            FullTimestamp:   true,
            TimestampFormat: &#34;15:04:05 02-01-2006&#34;,
        })

        logrus.SetOutput(os.Stdout)
        logrus.SetReportCaller(true)
        logrus.SetLevel(logLevel)
    }

    // run initLogger() before running main()
    func init() {
        config.GetConf()
        initLogger()
    }

    func main() {
        e := echo.New()

        db.InitializePostgresConn()
        bookRepo := _bookRepo.NewBookRepository(db.PostgresDB)
        bookUsecase := _bookUcase.NewBookUsecase(bookRepo)
        _bookHTTPHndlr.NewBookHTTPHandler(e, bookUsecase)

        s := &amp;http.Server{
            Addr:         &#34;:&#34; &#43; config.ServerPort(),
            ReadTimeout:  2 * time.Minute,
            WriteTimeout: 2 * time.Minute,
        }

        logrus.Fatal(e.StartServer(s))
    }

</code></pre>
  </div>


<p>The modifications made are only the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;github.com/ssentinull/create-apis-using-golang/internal/db&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">InitializePostgresConn</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">bookRepo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">_bookRepo</span>.<span style="color:#a6e22e">NewBookRepository</span>(<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">PostgresDB</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>We imported our Postgres database implementation from our <code>db</code> package, call the init function to initialize the connection and pass the database connection to our repository.</p>
<h2 id="testing-the-application">Testing the Application.</h2>
<p>After we&rsquo;ve done with all of that, it&rsquo;s time to test our database implementation.</p>
<ol>
<li>
<p>Create a new book.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/4.png"   />
        
      </figure>
    

<p>We create a new Post request in <a href="https://www.postman.com/">Postman</a> with a raw JSON body and include the following JSON object.</p>



  <div class="collapsable-code">
    <input id="6" type="checkbox"  />
    <label for="6">
      <span class="collapsable-code__language">json</span>
      <span class="collapsable-code__title">create book</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-json" ><code>

        {
            &#34;title&#34;: &#34;Harry Potter&#34;,
            &#34;author&#34;: &#34;J. K. Rowling&#34;,
            &#34;description&#34;: &#34;A book about wizardry and magic.&#34;,
            &#34;published_date&#34;: &#34;01-01-2021&#34;
        }

    </code></pre>
  </div>


<p>After that, we click the send button and check our database client. We see that the book data has been inserted in the books table.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/5.png"   />
        
      </figure>
    

</li>
<li>
<p>Read a book / books.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/6.png"   />
        
      </figure>
    

<p>We create a Get request with an <code>:ID</code> path variable and we include the <code>ID</code> of the book that we just created. We see that our service fetched our recently created book with all of its data.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/7.png"   />
        
      </figure>
    

<p>To demonstrate the fetching of multiple data, we create another book with different data. We then create a different Get request without an <code>:ID</code> path variable and click send. We see that our service returned the two books that we created.</p>
</li>
<li>
<p>Update a book.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/8.png"   />
        
      </figure>
    

<p>We create a Put request with a raw JSON body similar to when we create a book but we include the <code>ID</code> of the book we want to update and it will return the updated book.</p>



  <div class="collapsable-code">
    <input id="7" type="checkbox"  />
    <label for="7">
      <span class="collapsable-code__language">json</span>
      <span class="collapsable-code__title">update book</span>
      <span class="collapsable-code__toggle" data-label-expand="△" data-label-collapse="▽"></span>
    </label>
    <pre class="language-json" ><code>

        {
            &#34;id&#34;: 1682927026234896363,
            &#34;title&#34;: &#34;Updated Harry Potter&#34;,
            &#34;author&#34;: &#34;Updated J. K. Rowling&#34;,
            &#34;description&#34;: &#34;Updated a book about wizardry and magic.&#34;,
            &#34;published_date&#34;: &#34;01-01-2021&#34;
        }

    </code></pre>
  </div>


</li>
<li>
<p>Delete a book.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/9.png"   />
        
      </figure>
    

<p>We create a Delete request with an <code>:ID</code> path variable and we include the <code>ID</code> of the book we want to delete. After running the request our service will return a <code>No Content</code> response.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/11.png"   />
        
      </figure>
    

<p>When we check our database client we see that the <code>deleted_at</code> value of the book that we just deleted has been filled with the time when we deleted it.</p>

      <figure class="center" >
        <img src="/img/blogs/create-api-using-golang-db/10.png"   />
        
      </figure>
    

<p>And when we fetch all of the books, we see that only one book is listed.</p>
</li>
</ol>
<p>Congrats!! 🥳 You&rsquo;ve successfully connected a database to your application!! 👏 The next step would be to implement a caching mechanism for faster retrieval of data.</p>
<p>The Github repository for this step of this series can be found <a href="https://github.com/ssentinull/create-apis-using-golang/tree/be5e6172ea1fcbb5fd6fdfd9cf798c448984d471">here</a>.</p>
<p>I hope this could be beneficial to you. Thank you for taking the time to read this article. 🙏</p>
<p>&ndash; ssentinull</p>
<h2 id="references">References.</h2>
<ol>
<li><a href="https://www.youtube.com/watch?v=W2Z7fbCLSTw&amp;t=19s">7 Database Paradigms</a></li>
<li><a href="https://cloud.google.com/learn/what-is-a-relational-database">What is a Relational Database?</a></li>
<li><a href="https://www.freecodecamp.org/news/what-is-an-orm-the-meaning-of-object-relational-mapping-database-tools/">What is an ORM – The Meaning of Object Relational Mapping Database Tools</a></li>
</ol>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/blogs/create-api-using-golang-cache/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Create APIs using Golang | Part 4 : Implementing Cache.</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/blogs/create-api-using-golang-architecture/">
                  <span class="button__text">Create APIs using Golang | Part 2 : Application Architecture.</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >ssentinull</span
    >
    <span class="logo__cursor"></span>
  
</a>

       <div style="flex-direction: row; align-items: center; font-size: 1rem;">
         <span style="margin-right: 10px;">
             <a href="https://github.com/ssentinull"><i class="fa fa-github" style="font-size:24px"></i></a>
         </span>
         <span style="margin-right: 10px;">
             <a href="https://www.linkedin.com/in/ibnu-ahsani/"><i class="fa fa-linkedin" style="font-size:24px"></i></a>
         </span>
         <span>
             <a href="mailto:ibnu.muhari@gmail.com"><i class="fa fa-envelope" style="font-size:18px"></i></a>
         </span>
       </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
